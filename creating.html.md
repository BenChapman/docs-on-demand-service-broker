---
title: On-demand Service Broker Documentation
owner: London Services Enablement
---

# Creating the Service Author Deliverables

- [What is required of the Service Authors?](/on-demand-service-broker/creating.html#what-is-required-of-the-service-authors)
- [Creating a Service Release](/on-demand-service-broker/creating.html#creating-a-service-release)
- [Creating a Service Adapter](/on-demand-service-broker/creating.html#creating-a-service-adapter)
- [Supporting Service Plan Properties](/on-demand-service-broker/creating.html#service-plan-properties)
- [Service adapter interface](/on-demand-service-broker/creating.html#service-adapter-interface)
- [Subcommands](/on-demand-service-broker/creating.html#sub-commands)
  - [generate-manifest](/on-demand-service-broker/creating.html#generate-manifest)
     - [Output](/on-demand-service-broker/creating.html#generate-manifest-output)
     - [bosh-info](/on-demand-service-broker/creating.html#bosh-info)
     - [service-releases](/on-demand-service-broker/creating.html#service-releases)
     - [plan](/on-demand-service-broker/creating.html#plan)
     - [arbitrary parameters](/on-demand-service-broker/creating.html#arbitrary-parameters)
     - [previous manifest](/on-demand-service-broker/creating.html#previous-manifest)
  - [create-binding](/on-demand-service-broker/creating.html#create-binding)
     - [Output](/on-demand-service-broker/creating.html#create-binding-output)
     - [binding-ID](/on-demand-service-broker/creating.html#create-binding-id)
     - [bosh-VMs-JSON](/on-demand-service-broker/creating.html#create-bosh-vms-json)
     - [manifest](/on-demand-service-broker/creating.html#create-binding-manifest)
  - [delete-binding](/on-demand-service-broker/creating.html#delete-binding)
     - [Output](/on-demand-service-broker/creating.html#delete-binding-output)
     - [binding-ID](/on-demand-service-broker/creating.html#delete-binding-id)
     - [bosh-VMs-JSON](/on-demand-service-broker/creating.html#delete-binding-vm-json)
     - [manifest](/on-demand-service-broker/creating.html#delete-binding-manifest)
- [Packaging](/on-demand-service-broker/creating.html#packaging)

<a id="what-is-required-of-the-service-authors"></a>
## What is required of the Service Authors?
The following deliverables are required from the service authors:
- Service release(s)
  - BOSH release(s) to be deployed by the manifest that is generated by the Service Adapter
- Service Adapter BOSH release
  - Contains the Service Adapter CLI
- Documentation for the operator to configure plan definitions for the Service Adapter

For information about what is required of the Operator, see [Responsibilities of the Operator](/on-demand-service-broker/operating.html#responsibility-of-the-operator).

<a id="creating-a-service-release"></a>
## Creating a Service Release

A service release is a BOSH release that is deployed at instance creation time, once for each service instance, by the On-demand Service Broker (ODB). We have created two examples:
  * [Redis](https://github.com/pivotal-cf-experimental/redis-example-service-release)
  * [Kafka](https://github.com/pivotal-cf-experimental/kafka-example-service-release)

See the [BOSH docs](http://bosh.io/docs) for help creating a BOSH release. We recommend creating sample manifests that deploy the service release(s), as this will help you write the `generate-manifest` component of the Service Adapter later.

<a id="service-plan-properties"></a>
## Supporting Service Plan Properties
Service authors can choose to support certain properties for the service in the adapter code. These properties are service-specific traits used to customise the service. They do not necessarily map to jobs one to one; a plan property may affect multiple jobs in the deployment. Plan properties are a mechanism for the operator to define different plans.

Service authors must document the usage of plan properties for the operator.

For example
- the [Redis service adapter](https://github.com/pivotal-cf-experimental/redis-example-service-adapter/blob/master/adapter/redis_service_adapter.go) supports the `persistent` property which can be used to attach a disk to the vm.
- the [Kafka service adapter](https://github.com/pivotal-cf-experimental/kafka-example-service-adapter/blob/master/adapter/generate_manifest.go) supports the `auto_create_topics` property to enable auto creation of topics on the cluster.

<a id="creating-a-service-adapter"></a>
## Creating a Service Adapter

A Service Adapter is an executable invoked by ODB. It is expected to respond to three subcommands:

- `generate-manifest`

  Given information about
    * the BOSH director (e.g. stemcells, release names, UUID),
    * the instance (ID, arbitrary parameters, plan properties, IAAS resources),
    * the previous manifest, if this is an upgrade deployment,

  generate a BOSH manifest for your service instance deployment and print it to stdout as YAML.

- `create-binding`

  Create (unique, if possible) credentials for the service instance, printing them to stdout as JSON.
  
- `delete-binding`

  Invalidate the created credentials, if possible. Some services (e.g. Redis) are single-user, and this endpoint will do nothing.

The parameters, and expected output from these subcommands will be explained in detail below. For each of these subcommands, exit status 0 indicates that the command succeeded, and any non-zero status indicates failure.

<a id="service-adapter-interface"></a>
## Service adapter interface
A service adapter is expected to be implemented as a binary with the interface

```
service-adapter [subcommand] [params ...]
```

where the subcommand can be generate-manifest, create-binding, delete-binding

Examples are provided for [Redis](https://github.com/pivotal-cf-experimental/redis-example-service-adapter) and [Kafka](https://github.com/pivotal-cf-experimental/kafka-example-service-adapter). Note that these Golang examples import helper packages from ODB to help with cross-cutting concerns such as unmarshalling the JSON command line parameters. For example, see the use of `CommandLineHelper` in the [redis-adapter](https://github.com/pivotal-cf-experimental/redis-example-service-adapter/blob/master/cmd/service-adapter/main.go#L14).
<a id="sub-commands"></a>
## Subcommands
<a id="generate-manifest"></a>
### generate-manifest

```
service-adapter generate-manifest [bosh-info-JSON] [service-releases-JSON] [plan-JSON] [arbitary-params-JSON] [previous-manifest-YAML]
```

The generate-manifest subcommand takes in 5 arguments and returns a BOSH deployment manifest YAML.

<a id="generate-manifest-output"></a>
#### Output

If the `generate-manifest` command is successful, it should return an exit code of 0 and print the BOSH manifest YAML to stdout. If the command failed, it should return any non-zero exit code. Stdout and stderr from the command will be logged by the ODB.

<a id="bosh-info"></a>
#### bosh-info
Provides information regarding the bosh director

| field            |  Type  |                                                   Description |
|:-----------------|:------:|--------------------------------------------------------------:|
| director_uuid    | string | guid of the director, which can be injected into the manifest |
| name             | string |                                          name of the director |
| stemcell_os      | string |                         stemcell os available on the director |
| stemcell_version | string |                    stemcell version available on the director |

For example

```json
{  
   "director_uuid":"a-uuid",
   "name":"a-name",
   "stemcell_os":"BeOS",
   "stemcell_version":"2"
}
```

ODB only supports injecting one stemcell into each service deployment (different instance groups cannot have different stemcells).

<a id="service-releases"></a>
#### service-releases
A list of service releases configured for the deployment by the operator. Each item in the service-releases array has the structure:

| field   |       Type       |                            Description |
|:--------|:----------------:|---------------------------------------:|
| name    |      string      |    name of the release on the director |
| version |      string      |                 version of the release |
| jobs    | array of strings | list of jobs required from the release |


For example

```json
[
   {
      "name":"kafka",
      "version":"dev.42",
      "jobs":[
         "kafka_node",
         "zookeeper"
      ]
   }
]
```

Your Service Adapter should be opinionated about which jobs it requires to generate its manifest. For example, the Kafka example requires `kafka_node` and `zookeeper`. It should not be opinionated about the mapping of BOSH release to job. The jobs can all be provided by one release, or across many. [Here](https://github.com/pivotal-cf-experimental/kafka-example-service-adapter/blob/master/deploymentinstancegroups/deployment_instance_groups.go) is an example of mapping the service releases parameter to a BOSH manifest `releases` and `instance_groups` sections.

You should provide documentation about which jobs are required by your Service Adapter, and which BOSH releases operators should get these jobs from.

<a id="plan"></a>
#### plan
Plan for which the manifest is supposed to be generated

| field                               |           Type           |                                                                                                 Description |
|:------------------------------------|:------------------------:|------------------------------------------------------------------------------------------------------------:|
| instance_groups                     | array of instance groups |                                                                     instance groups configured for the plan |
| instance_group.name                 |          string          |                                                                                  name of the instance group |
| instance_group.vm_type              |          string          |              the vm_type configured for the instance group, matches one in the cloud config on the director |
| instance_group.persistent_disk_type |          string          | the persistent_disk_type configured for the instance group, matches one in the cloud config on the director |
| instance_group.networks             |     array of strings     |                                                        the networks the instance group is supposed to be in |
| instance_group.instances            |           int            |                                                                  number of instances for the instance group |
| properties                          |           map            |                  properties with which the operator has configured the instance group, for the current plan |

For example

```json
{
   "instance_groups":[
      {
         "name":"example-server",
         "vm_type":"small",
         "persistent_disk_type":"ten",
         "networks":[
            "example-network"
         ],
         "azs":[
            "example-az"
         ],
         "instances":1
      }
   ],
   "properties":{
      "example":"property"
   }
}
```

Plans are composed by the operator and consist of properties and resource mappings:

* **Properties**

  Properties are service-specific parameters chosen by the service author. The Redis example exposes a property `persistence`, which takes a boolean value and toggles disk persistence for Redis. These should be documented by the service developers for the operator.

* **Resource mappings**

  The `instance_groups` section of the plan JSON. This maps service deployment instance groups (defined by the service author) to resources (defined by the operator). The service developers should document the list of instance group names required for their deployment (e.g. "redis-server") and any constraints they recommend on resources (e.g. operator must add a persistent disk if persistence property is enabled). These constraints can of course be enforced in code.

<a id="arbitrary-parameters"></a>
#### arbitrary parameters
This is a JSON object with arbitrary keys and values which were passed by the application developer as a `cf` CLI parameter when creating a service or updating the service.

<a id="previous-manifest"></a>
#### previous manifest
The previous manifest as YAML. The previous manifest is nil if this is a new deployment. The format of the manifest should match the [bosh v2 manifest](https://bosh.io/docs/manifest-v2.html).

It is up to the service author to perform any necessary service-specific migration logic here, if previous manifest is non-nil.

For example see the [kafka generate manifest code](https://github.com/pivotal-cf-experimental/kafka-example-service-adapter/blob/master/cmd/service-adapter/main.go#L36)

<a id="generate-manifest-output"></a>

---

<a id="create-binding"></a>
### create-binding

```
service-adapter create-binding [binding-ID] [bosh-VMs-JSON] [manifest-YAML]
```

Binding credentials for a service instance should share a namespace, and should be unique if possible. E.g. for MySQL, two bindings could include a different username/password pairs, but share the same MySQL database tables and data. The first step is to determine which credentials are best to supply in the context of your service. We recommend that users can be identified statelessly from the binding ID, and the simplest way to do this is to name the user after the binding ID.

Note that at this time ODB does not support syslog drains or route services, so bindings are only a map of credentials.

<a id="create-binding-output"></a>
#### Output

If the `create-binding` command is successful, it should return an exit code of 0 and print the arbitrary credentials JSON on stdout. If the command failed, it should return any non-zero exit code. Stdout and stderr from the command will be logged by the ODB.

<a id="create-binding-id"></a>
#### binding-ID
The binding-ID generated by the Cloud Controller.

<a id="create-bosh-vms-json"></a>
#### bosh-VMs-JSON
A map of instance group name to an array of IPs provisioned for that instance group.

For example

```json
{
  "mysql_node": ["10.0.0.1", "10.0.0.2", "10.0.0.3"],
  "management_box": ["10.0.0.4"]
}
```

This can be used to connect to the instance deployment if required, to create a service specific binding. In the example above, the Service Adapter may connect to MySQL as the admin and create a user. As part of the binding, the `mysql_node` IPs would be returned, but maybe not the `management_box`.

<a id="create-binding-manifest"></a>
#### manifest
The current manifest as YAML. This is used to extract information about the deployment that is necessary for the binding (e.g. admin credentials with which to create users). The format of the manifest should match the [bosh v2 manifest](https://bosh.io/docs/manifest-v2.html)

For example see the [kafka create binding](https://github.com/pivotal-cf-experimental/kafka-example-service-adapter/blob/master/cmd/service-adapter/main.go#L61)

---

<a id="delete-binding"></a>
### delete-binding

```
service-adapter delete-binding [binding-ID] [bosh-VMs-JSON] [manifest-YAML]
```

This should invalidate the credentials that were generated by `create-binding` if possible. E.g. for MySQL, it would delete the binding user.

<a id="delete-binding-output"></a>
#### Output

If the `delete-binding` command is successful, it should output a exit code of 0. No other output is required. If the command failed, it should return any non-zero exit code. Stdout and stderr from the command will be logged by the ODB.

<a id="delete-binding-id"></a>
#### binding-ID
The binding to be deleted.

<a id="delete-binding-vm-json"></a>
#### bosh-VMs-JSON
A map of instance group name to an array of IPs provisioned for that instance group.

For example

For example

```json
{
  "my-instance-group": ["10.0.0.1", "10.0.0.2", "10.0.0.3"]
}
```

This can be used to connect to the actual VMs if required, to delete a service specific binding. For example delete a user in MySQL.

<a id="delete-binding-manifest"></a>
#### manifest
The current manifest as YAML. This is used to extract information about the deployment that is necessary for the binding (e.g. credentials). The format of the manifest should match the [bosh v2 manifest](https://bosh.io/docs/manifest-v2.html)

For example see the [kafka delete binding](https://github.com/pivotal-cf-experimental/kafka-example-service-adapter/blob/master/cmd/service-adapter/main.go#L73)

<a id="packaging"></a>
## Packaging
The adapter should be packaged as a BOSH release, which should be co-located with the ODB release in a BOSH manifest by the operator. This is only done in order to place the adapter executable on the same VM as the ODB server, therefore the adapter BOSH job's `monit` file should probably have no processes defined.

Example service adapter releases:
- [kafka](https://github.com/pivotal-cf-experimental/kafka-example-service-adapter-release)
- [redis](https://github.com/pivotal-cf-experimental/redis-example-service-adapter-release)

**[Back to Contents Page](/on-demand-service-broker/index.html)**
